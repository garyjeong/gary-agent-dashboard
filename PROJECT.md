# Gary Agent Dashboard — 프로젝트 정의

## 1. 목적

- **Jira형 대시보드**로 일감(이슈/태스크)을 생성·수정·조회하고, **GitHub 계정과 연동**해 리포/이슈 정보를 활용한다.
- 일감에 대한 **작업 요청**을 등록하면 **작업 큐**에 넣고, **로컬 에이전트(Claude Code / Cursor Agent 등)** 또는 **서버 측 LLM API**가 그 큐를 소비해 자동으로 작업하도록 한다.
- 즉, “일감 관리 + GitHub 연동 + 에이전트에 할 일 전달”을 하나의 대시보드·백엔드로 수행하는 것이 목적이다.

---

## 2. 기능 정의

### 2.1 사용자·인증

- 사용자 로그인(이메일/소셜 또는 GitHub OAuth).
- **GitHub OAuth 연동**: 계정 연결 후 리포지토리·이슈 목록 조회, (선택) 이슈 ↔ 일감 매핑.

### 2.2 일감(이슈/태스크) 관리 — Jira형

- **일감 CRUD**
  - 제목, 설명, 우선순위, 상태(예: Todo / In Progress / Done), 담당자(선택), 마감일(선택), 라벨/태그.
- **목록·필터·정렬**
  - 상태·우선순위·담당자·라벨로 필터, 정렬(생성일/마감일/우선순위 등).
- **상세 뷰**
  - 일감 상세 + 댓글/활동 이력(선택).

#### 2.2.1 일감 카드 생성 시 동작 추론·예시

- 대시보드에서 **일감 카드를 생성**할 때, 시스템이 **카드 내용(제목·설명)** 과 **연결된 GitHub 프로젝트(리포) 구조**를 파악한다.
- 이를 바탕으로 **이 일감이 어떻게 동작해야 하는지 추론**하고, **작업에 대한 동작 예시(실행 시나리오)** 를 생성해 카드에 포함한다.
- **플로우 요약**
  1. 사용자가 일감 제목·설명(및 선택: 대상 리포) 입력.
  2. (선택) 지정/기본 리포의 구조(디렉터리, 주요 파일, README 등)를 조회·분석.
  3. 내용 + 프로젝트 구조를 기반으로 **예상 동작·실행 예시**를 생성(규칙 또는 LLM 활용). 예: “이 일감 시 브랜치 생성 → `src/api/` 수정 → 테스트 실행” 등.
  4. 생성된 **동작 예시**를 일감 카드의 필드(예: `behaviorExample` 또는 “동작 예시” 섹션)로 저장하고 대시보드에 표시.
- 에이전트(로컬 워커)는 이 **동작 예시**를 참고해 실제 작업 순서·범위를 결정할 수 있다.

### 2.3 작업 요청·큐

- 일감에 **「작업 요청」** 버튼/액션으로 “에이전트가 할 일”을 등록.
- 등록 시 **작업 큐(백엔드)** 에 항목 추가: 일감 ID, 요청 내용, 우선순위, **담당 에이전트 타입(`assigned_agent_type`)**, 생성 시각 등.
- 큐 항목 상태: 대기 / 처리중 / 완료 / 실패.
- **담당 에이전트**: `gemini_pro` 또는 `claude_code`. 미지정 시 워커 설정 기본값 사용.

### 2.4 GitHub 연동 — 다중 프로젝트 관리

- 연결된 GitHub 계정의 **여러 리포지토리(프로젝트)** 를 대시보드에서 **통합 관리**한다.
- **리포지토리 목록** 조회·선택, **프로젝트별 일감** 조회/필터(예: “이 리포에 속한 일감만 보기”).
- **이슈 목록** 조회(리포 단위). (선택) GitHub 이슈 ↔ 대시보드 일감 **연결/동기화**.
- 일감 생성·수정 시 **대상 프로젝트(리포)** 를 지정할 수 있도록 하여, 여러 GitHub 프로젝트를 한 대시보드에서 구분해 관리한다.

### 2.5 텔레그램 알림

- **일감 작업 완료 시** 텔레그램 봇으로 **알림 전송**.
- **알림 템플릿**을 **대시보드에서 사용자가 수정**할 수 있다.
  - 예: 제목/본문 포맷, 치환 변수(일감 제목, 상태, 완료 시각, 링크 등). 저장 시 해당 템플릿으로 봇 메시지가 전송된다.

### 2.6 AI 분석 파이프라인 (담당 모델 구분)

| 단계 | 담당 모델 | 역할 |
|------|-----------|------|
| 프로젝트 등록·기본 분석 | **Gemini Flash** | 리포 트리·주요 파일 분석, 요약 생성 |
| 심층 분석 | **Gemini Pro** | 소스 코드 품질/보안/성능 분석, 개선 제안 |
| 일감 생성 분석 | **Gemini Flash** | 제목·우선순위·라벨·리포 추천, 작업 계획(behavior_example) 생성 |
| 일감 수행 | **Gemini Pro** 또는 **Claude Code** | 실제 코드 변경·커밋·PR (큐 항목별 `assigned_agent_type` 지정) |

### 2.7 에이전트 연동(자동 처리)

- **서버에서 할 수 있는 것**
  - 큐 API 제공: "다음 할 일" 조회(`GET /api/queue/next?agent_type=...`), 상태 업데이트.
  - **Gemini API**를 서버에서 호출해 리포 분석·일감 작업 계획 생성. 결과를 일감에 필드로 저장.
- **로컬 에이전트(Claude Code)와 연동**
  - 워커가 `GET /api/queue/next?agent_type=claude_code`로 자신의 타입에 배정된 큐 항목만 폴링.
  - `GET /api/queue/repo-analysis/{full_name}`으로 기본+심층 분석 결과 수신.
  - 완료 후 `PATCH /api/queue/:id`로 결과·상태 전송.
- 큐 항목이 **완료**로 업데이트되면, 2.5에 따라 **텔레그램 알림**을 발송한다(저장된 템플릿 사용).
---

## 3. 구현 방식

### 3.1 전체 구조

- **프론트엔드**: Jira형 대시보드(일감 목록·상세·생성·수정·필터·정렬, **여러 GitHub 프로젝트 선택/관리**, 작업 요청 버튼, **텔레그램 알림 템플릿 편집 UI**).
- **백엔드**: REST(또는 GraphQL) API 서버. 인증, 일감 CRUD, **일감 생성 시 동작 예시 생성**, 작업 큐, GitHub OAuth·API 프록시, **텔레그램 봇 발송·템플릿 저장**, **다중 리포 관리**.
- **DB**: 사용자, 일감(동작 예시 필드 포함), 큐 항목, **알림 템플릿**, (선택) 댓글/이력 저장.
- **에이전트 연동**: 큐 소비 API(`agent_type` 필터 지원) + 서버 측 Gemini Flash/Pro 호출; 완료 시 텔레그램 알림. Claude Code 연동은 로컬 워커가 큐 소비.

### 3.2 기술 스택

- **프론트**: Next.js 16 + React 19 + TypeScript + Tailwind CSS + SWR + Zustand + @dnd-kit.
- **백엔드**: Python 3.12 + FastAPI + SQLAlchemy(비동기) + Pydantic. **명시적 매개변수**(키워드 인자) 사용 원칙.
- **DB**: PostgreSQL 16. 일감·큐(`assigned_agent_type` 포함)·사용자·리포 분석 테이블.
- **AI 분석**: Gemini Flash(기본/일감 분석), Gemini Pro(심층 분석/일감 수행).
- **인증**: JWT + 리프레시 토큰. GitHub OAuth로 토큰 발급, Fernet으로 암호화 저장.
- **큐**: DB 테이블 기반 큐(상태·우선순위·`assigned_agent_type`·created_at). `with_for_update(skip_locked)` 동시 처리 지원.

### 3.3 API 설계(핵심)

- `GET/POST /issues` — 일감 목록(쿼리: 상태, 우선순위 등), 일감 생성.
- `GET/PATCH/DELETE /issues/:id` — 일감 상세, 수정, 삭제.
- `POST /issues/:id/work-request` — 해당 일감에 대한 작업 요청 등록(큐에 추가). 본문에 `assigned_agent_type` 지정 가능.
- `GET /queue/next` — (에이전트/워커용) 다음 처리할 큐 항목 조회, 상태를 “처리중”으로 변경.
- `PATCH /queue/:id` — 큐 항목 상태·결과 업데이트(완료/실패, 결과 본문 등).
- `GET /github/repos`, `GET /github/repos/:owner/:repo/issues` — GitHub 연동(프록시 또는 백엔드에서 토큰으로 호출). 일감 목록/생성 시 `repo`(또는 `projectId`)로 **다중 프로젝트** 구분.
- `GET/PATCH /settings/telegram-template` — **텔레그램 알림 템플릿** 조회·수정(대시보드에서 편집 시 호출).
- 큐 항목 완료 처리 시 내부에서 **텔레그램 봇 API** 호출(저장된 템플릿 + 치환 변수).

### 3.4 로컬 워커(Claude Code / Cursor Agent 연동)

- 별도 스크립트/CLI 또는 소형 서비스가 주기적으로 `GET /queue/next` 호출.
- 항목이 있으면 로컬에서 Cursor/Claude Code용 명령 또는 스크립트 실행(예: “이 일감 내용으로 브랜치 생성·코드 수정” 등).
- 완료 후 `PATCH /queue/:id`로 결과·상태 전송.
- Cursor/Claude Code 자체는 서버에 설치·실행하지 않고, “할 일”만 서버(큐)에서 가져와 로컬에서 처리하는 구조.

### 3.5 텔레그램 알림 구현

- **봇 토큰**: 환경변수 또는 시크릿 저장소에 보관. 채팅 ID(알림 수신 대상)는 사용자 설정 또는 DB에 저장.
- **템플릿 저장**: DB 또는 설정 테이블에 제목/본문 문자열 저장. 치환 변수 예: `{{issueTitle}}`, `{{status}}`, `{{completedAt}}`, `{{dashboardUrl}}`.
- **발송 시점**: `PATCH /queue/:id`로 상태가 “완료”로 변경될 때 서버에서 텔레그램 Bot API 호출.

### 3.6 보안·운영

- GitHub 토큰·API 키·텔레그램 봇 토큰은 환경변수 또는 시크릿 저장소에 보관, 코드/로그에 노출 금지.
- 큐 API는 인증(API 키 또는 JWT) 적용. `GET /queue/next`는 워커 전용 권한으로 제한 권장.

---

## 4. 문서 정리

- **목적**: Jira형 일감 대시보드 + **여러 GitHub 프로젝트** 연동 + 작업 큐를 통한 에이전트(로컬/서버) 자동 작업 + **완료 시 텔레그램 알림**.
- **기능**
  - 사용자·GitHub OAuth, **다중 리포 관리**, 일감 CRUD·필터·정렬.
  - **일감 카드 생성 시**: 내용·프로젝트 구조 파악 → **동작 추론·동작 예시** 생성 후 카드에 포함.
  - 작업 요청·큐(`assigned_agent_type` 지정), 큐 소비 API, 서버 측 Gemini Flash/Pro 호출.
  - **일감 완료 시 텔레그램 봇 알림**; **알림 템플릿은 대시보드에서 사용자 수정 가능**.
- **AI 분석 파이프라인**: 기본 분석(Flash) → 심층 분석(Pro) → 일감 생성 분석(Flash) → 일감 수행(Pro/Claude Code, 큐 항목별 지정).
- **구현**: 프론트(대시보드 + 템플릿 편집 + 다중 프로젝트 UI) + 백엔드(API·DB·큐·GitHub·텔레그램·Gemini AI 분석) + 로컬 워커(큐 폴링 후 Claude Code에서 처리).
